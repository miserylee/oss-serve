{"version":3,"file":"index.js","sourceRoot":"","sources":["index.ts"],"names":[],"mappings":"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","sourcesContent":["import * as ossClient from 'ali-oss';\nimport * as co from 'co';\nimport * as dirTraveler from 'dir-traveler';\nimport * as fs from 'fs';\nimport * as hasha from 'hasha';\nimport * as multimatch from 'multimatch';\nimport * as path from 'path';\n\nconst LABEL = 'oss-serve:';\n\nfunction mkDirsSync(p: string): void {\n  if (!fs.existsSync(p)) {\n    mkDirsSync(path.dirname(p));\n    fs.mkdirSync(p);\n  }\n}\n\nexport interface IOptions {\n  oss: {\n    accessKeyId: string,\n    accessKeySecret: string,\n    bucket: string,\n    region: string,\n  };\n  destination?: string;\n  match?: string[];\n  baseUrl: string;\n}\n\ninterface IStore {\n  head(object: string): Iterable<{\n    meta: {\n      hash: string,\n    },\n  }>;\n\n  list(opts: {\n    prefix: string,\n  }): Iterable<IList>;\n\n  put(object: string, file: string, opts: {\n    meta: { hash: object };\n  }): Iterable<void>;\n\n  get(object: string, file: string): Iterable<void>;\n\n  getObjectUrl(object: string, baseUrl: string): string,\n}\n\ninterface IList {\n  objects: Array<{\n    name: string;\n  }>;\n}\n\nexport type callback = (error?: Error) => void | undefined;\n\nexport default class Serve {\n  private _store: IStore;\n  private _destination: string;\n  private _match: string[];\n  private _baseUrl: string;\n\n  constructor({ oss, destination = '', match = ['**'], baseUrl }: IOptions) {\n    this._store = ossClient(oss);\n    this._destination = destination;\n    this._match = match;\n    this._baseUrl = baseUrl;\n  }\n\n  public push(root: string, cb: callback = _ => undefined) {\n    if (!fs.existsSync(root)) {\n      throw new Error('Root is not exists!');\n    }\n    (async _ => {\n      const files = dirTraveler(root);\n      // list remote files\n      const list = await this._storeList({\n        prefix: this._destination,\n      });\n\n      const keys = this._filterObjects(list);\n      // check locale files\n      const localKeys = multimatch(Object.keys(files), this._match);\n      for (const key of localKeys) {\n        const file = files[key];\n        const object = this._keyToObject(key);\n\n        const index = keys.indexOf(key);\n        if (index >= 0) {\n          keys.splice(index, 1);\n        }\n\n        // update file\n        try {\n          if (await this._checkFileMata(file, object)) {\n            console.log(LABEL, `Remote file '${object}' need to update.`);\n\n            const hash = await hasha.fromFile(file, { algorithm: 'md5' });\n\n            await this._storePut(object, file, {\n              meta: { hash },\n            });\n            console.log(LABEL, `Remote file '${object}' update success!`);\n          } else {\n            console.log(LABEL, `Remote file '${object}' is fresh.`);\n          }\n        } catch (err) {\n          // update file failed;\n          console.error(LABEL, `Update remote file '${object}' failed with error: ${err.message}`);\n        }\n      }\n\n      for (const key of keys) {\n        const object = this._keyToObject(key);\n        try {\n          console.log(LABEL, `Remote file '${object}' need to remove.`);\n          await  this._storeDelete(object);\n          console.log(LABEL, `Remote file '${object}' removed success!`);\n        } catch (err) {\n          // delete file failed\n          console.error(LABEL, `Delete remote file '${object}' failed with error: ${err.message}`);\n        }\n      }\n\n      try {\n        const object = this._keyToObject('index.html');\n        await this._storeGet(object);\n\n        console.log(LABEL, `Open link ${this._store.getObjectUrl(object, this._baseUrl)} in browser to view.`);\n      } catch (err) {\n        // index.html do not exists;\n        console.warn(LABEL, 'File index.html should serve.');\n      }\n    })().then(_ => {\n      cb();\n    }).catch(err => {\n      console.error(LABEL, err.message);\n      cb(err);\n    });\n  }\n\n  public pull(root: string, cb: callback = _ => undefined) {\n    (async _ => {\n      // list remote files\n      const list = await this._storeList({ prefix: this._destination });\n\n      const keys = this._filterObjects(list);\n      // get files from remote\n      for (const key of keys) {\n        if (key.slice(-1) === '/') {\n          continue;\n        }\n        const file = path.resolve(root, key);\n        const dir = path.dirname(file);\n        mkDirsSync(dir);\n        const object = this._keyToObject(key);\n\n        if (await this._checkFileMata(file, object)) {\n          await this._storeGet(object, file);\n          console.log(LABEL, `Fetched remote file '${object}' success!`);\n        } else {\n          console.log(LABEL, `Local File '${object}' is fresh.`);\n        }\n      }\n    })().then(_ => {\n      cb();\n    }).catch(err => {\n      console.error(LABEL, err.message);\n      cb(err);\n    });\n  }\n\n  private _filterObjects(list: IList) {\n    const objects = list.objects.map(object => {\n      return path.relative(this._destination, object.name);\n    });\n    return multimatch(objects, this._match);\n  }\n\n  private _keyToObject(key: string): string {\n    return this._destination ? [this._destination, key].join('/') : key;\n  }\n\n  private async _checkFileMata(file: string, object: string) {\n    // check file me;\n    try {\n      const result = await this._storeHead(object);\n      if (result.meta.hash) {\n        if (!fs.existsSync(file)) {\n          return true;\n        }\n        const hash = await hasha.fromFile(file, { algorithm: 'md5' });\n        if (hash !== result.meta.hash) {\n          return true;\n        }\n      }\n    } catch (err) {\n      // file not exists.\n      // console.warn(LABEL, `Head file '${object}' failed with error: ${err.message}`);\n      if (err.status === 404) { return true; }\n    }\n    return false;\n  }\n\n  private async _storeList(...params) {\n    return co(function *() {\n      return yield this._store.list(...params);\n    }.bind(this));\n  }\n\n  private async _storeHead(...params) {\n    return co(function *() {\n      return yield this._store.head(...params);\n    }.bind(this));\n  }\n\n  private async _storeGet(...params) {\n    return co(function *() {\n      return yield this._store.get(...params);\n    }.bind(this));\n  }\n\n  private async _storePut(...params) {\n    return co(function *() {\n      return yield this._store.put(...params);\n    }.bind(this));\n  }\n\n  private async _storeDelete(...params) {\n    return co(function *() {\n      return yield this._store.delete(...params);\n    }.bind(this));\n  }\n}\n"]}